<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>One Fav – Favorieten</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    html, body { height: 100%; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- App bar -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
    <div class="mx-auto max-w-md px-4 pt-[max(0.5rem,var(--sat))] pb-3">
      <div class="flex items-center justify-between">
        <h1 class="text-lg font-semibold">⭐ One Fav</h1>
        <div class="flex items-center gap-2">
          <button id="btnOpenJson" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50" title="Open JSON-bestand">Open JSON</button>
          <button id="btnSaveJson" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50" title="Opslaan naar JSON">Opslaan JSON</button>
          <button id="btnExport" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50" title="Export JSON (download)">Export</button>
          <label class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50 cursor-pointer" title="Import JSON (bestand kiezen)">
            Import
            <input id="fileImport" type="file" accept="application/json" class="hidden" />
          </label>
          <button id="btnReset" class="text-xs px-2 py-1 rounded-lg border hover:bg-gray-50" title="Reset alle data">Reset</button>
        </div>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <div class="relative flex-1">
          <input id="txtSearch" type="text" placeholder="Zoek in favorieten… of typ g:, y:, b:, l: voor web" class="w-full p-2 pl-9 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" />
          <svg class="absolute left-2 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"/></svg>
        </div>
        <select id="searchEngine" class="p-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-sky-400" title="Zoekmachine">
          <option value="google">Google</option>
          <option value="youtube">YouTube</option>
          <option value="bing">Bing</option>
          <option value="linkedin">LinkedIn</option>
        </select>
        <button id="btnAdd" class="px-3 py-2 rounded-xl bg-sky-500 text-white hover:bg-sky-600" title="Favoriet toevoegen">Toevoegen</button>
      </div>
      <div id="chipRow" class="mt-2 flex gap-2 overflow-x-auto no-scrollbar"></div>
    </div>
  </header>

  <!-- Content -->
  <main class="mx-auto w-full max-w-md flex-1 px-4 py-4">
    <div id="grid" class="grid grid-cols-4 gap-3 sm:grid-cols-5"></div>

    <template id="tplEmpty">
      <div class="text-center text-gray-500 text-sm py-16">
        Nog geen favorieten. Tik op <span class="font-medium">Toevoegen</span> om te starten ✨
      </div>
    </template>

    <template id="tplTile">
      <button class="group flex flex-col items-center gap-1 p-2 rounded-2xl bg-white border shadow-sm hover:shadow transition">
        <img class="w-12 h-12 rounded-xl object-contain border bg-white" alt="icoon" />
        <span class="w-full text-center text-[11px] leading-tight font-medium truncate"></span>
      </button>
    </template>
  </main>

  <!-- Add/Edit Sheet -->
  <div id="sheet" class="fixed inset-x-0 bottom-0 z-20 hidden">
    <div class="mx-auto max-w-md rounded-t-3xl border-t border-x bg-white shadow-2xl p-4 pb-[max(1rem,var(--sab))]">
      <div class="flex items-center justify-between">
        <h2 id="sheetTitle" class="text-base font-semibold">Nieuw favoriet</h2>
        <button id="btnCloseSheet" class="p-2 text-gray-500 hover:text-gray-700" aria-label="Sluiten">✕</button>
      </div>
      <div class="mt-2 grid gap-2">
        <label class="text-xs text-gray-500">Naam
          <input id="fldTitle" type="text" class="mt-1 w-full p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Bijv. LinkedIn" />
        </label>
        <label class="text-xs text-gray-500">URL
          <input id="fldUrl" type="url" class="mt-1 w-full p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="https://linkedin.com" />
        </label>
        <div class="grid grid-cols-2 gap-2">
          <label class="text-xs text-gray-500">Categorie
            <input id="fldCategory" type="text" class="mt-1 w-full p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Apps / Links / GPT / Connecties" />
          </label>
          <label class="text-xs text-gray-500">Tags (komma's)
            <input id="fldTags" type="text" class="mt-1 w-full p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="werk, netwerk" />
          </label>
        </div>
        <label class="text-xs text-gray-500">Icoon (optioneel)
          <input id="fldIcon" type="url" class="mt-1 w-full p-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="https://.../favicon.ico of png" />
        </label>
        <div class="flex items-center justify-between mt-1">
          <button id="btnDelete" class="hidden text-red-600 text-sm px-3 py-2 rounded-xl border border-red-200 hover:bg-red-50">Verwijderen</button>
          <div class="ml-auto flex gap-2">
            <button id="btnCancel" class="px-3 py-2 rounded-xl border hover:bg-gray-50">Annuleren</button>
            <button id="btnSave" class="px-4 py-2 rounded-xl bg-sky-500 text-white hover:bg-sky-600">Opslaan</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /** @typedef {{id:string,title:string,url:string,category:string,tags:string[],icon:string}} Favorite */

    // DOM refs
    const txtSearch = document.getElementById('txtSearch');
    const searchEngine = document.getElementById('searchEngine');
    const chipRow = document.getElementById('chipRow');
    const grid = document.getElementById('grid');
    const tplEmpty = document.getElementById('tplEmpty');
    const tplTile = document.getElementById('tplTile');

    const btnAdd = document.getElementById('btnAdd');
    const btnReset = document.getElementById('btnReset');
    const btnOpenJson = document.getElementById('btnOpenJson');
    const btnSaveJson = document.getElementById('btnSaveJson');
    const btnExport = document.getElementById('btnExport');
    const fileImport = document.getElementById('fileImport');

    const sheet = document.getElementById('sheet');
    const sheetTitle = document.getElementById('sheetTitle');
    const btnCloseSheet = document.getElementById('btnCloseSheet');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('btnSave');
    const btnDelete = document.getElementById('btnDelete');

    const fldTitle = document.getElementById('fldTitle');
    const fldUrl = document.getElementById('fldUrl');
    const fldCategory = document.getElementById('fldCategory');
    const fldTags = document.getElementById('fldTags');
    const fldIcon = document.getElementById('fldIcon');

    // State
    let favorites = JSON.parse(localStorage.getItem('favorites_v1')||'[]');
    let editingId = null;
    /** @type {FileSystemFileHandle|null} */
    let fileHandle = null;  // voor directe bestandsopslag (Chromium/Edge)

    // Utils
    function fav(title,url,category,tags){ return { id: crypto.randomUUID(), title, url, category, tags, icon: faviconFor(url) }; }
    function save(){ localStorage.setItem('favorites_v1', JSON.stringify(favorites)); }
    function domainFromUrl(u){ try { return new URL(u).hostname; } catch { return ''; } }
    function faviconFor(u){ const d = domainFromUrl(u); return d ? `https://www.google.com/s2/favicons?sz=64&domain_url=${d}` : ''; }
    function unique(arr){ return Array.from(new Set(arr)); }

    async function tryLoadDefaultJson(){
      try{
        const res = await fetch('favorites.json', { cache: 'no-store' });
        if(res.ok){
          const data = await res.json();
          if(Array.isArray(data)){ favorites = data; save(); }
        }
      } catch {}
    }

    async function openJsonFile(){
      if (window.showOpenFilePicker) {
        try{
          const [handle] = await window.showOpenFilePicker({
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] }}]
          });
          const file = await handle.getFile();
          const text = await file.text();
          const data = JSON.parse(text);
          if(Array.isArray(data)){
            favorites = data; save(); renderChips(); renderGrid();
            fileHandle = handle;
            alert('JSON geladen en gekoppeld. Opslaan gaat nu naar dit bestand.');
          } else {
            alert('Het gekozen bestand bevat geen lijst.');
          }
        } catch {}
      } else {
        fileImport.click(); // fallback
      }
    }

    async function saveToJson(){
      const content = JSON.stringify(favorites, null, 2);
      if (fileHandle && fileHandle.createWritable) {
        try{
          const writable = await fileHandle.createWritable();
          await writable.write(content);
          await writable.close();
          alert('Opgeslagen naar gekoppeld JSON-bestand.');
          return;
        } catch { alert('Opslaan naar bestand mislukt. Gebruik Export als fallback.'); }
      }
      // Fallback: download
      const blob = new Blob([content], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'one-fav-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // UI
    function renderChips(){
      chipRow.innerHTML = '';
      const cats = unique(['Alle', ...favorites.map(f=>f.category).filter(Boolean)]).sort((a,b)=>a.localeCompare(b));
      cats.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'shrink-0 text-xs px-3 py-1.5 rounded-full border bg-white hover:bg-gray-50';
        btn.textContent = cat;
        btn.addEventListener('click', ()=>{
          txtSearch.dataset.cat = cat==='Alle' ? '' : cat;
          renderGrid();
        });
        chipRow.appendChild(btn);
      });
    }

    function matchesFilter(f){
      const q = (txtSearch.value||'').toLowerCase().trim();
      const cat = (txtSearch.dataset.cat||'').toLowerCase();
      const inCat = !cat || (f.category||'').toLowerCase() === cat;
      const text = [f.title, f.url, f.category, ...(f.tags||[])].join(' ').toLowerCase();
      return inCat && text.includes(q);
    }

    function renderGrid(){
      grid.innerHTML = '';
      const list = favorites.filter(matchesFilter);
      if(list.length === 0){
        grid.appendChild(tplEmpty.content.cloneNode(true));
        return;
      }
      list.forEach(f => {
        const frag = tplTile.content.cloneNode(true);
        const btn = frag.querySelector('button');
        const img = frag.querySelector('img');
        const lbl = frag.querySelector('span');
        img.src = f.icon || faviconFor(f.url);
        img.alt = `${f.title} icoon`;
        lbl.textContent = f.title;
        btn.title = `${f.title} — ${f.url}`;
        btn.addEventListener('click', ()=> window.open(f.url, '_blank'));
        btn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openSheet(f.id); });
        grid.appendChild(frag);
      });
    }

    // Sheet
    function openSheet(id){
      sheet.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      if(id){
        editingId = id;
        const f = favorites.find(x=>x.id===id);
        sheetTitle.textContent = 'Favoriet bewerken';
        fldTitle.value = f.title;
        fldUrl.value = f.url;
        fldCategory.value = f.category || '';
        fldTags.value = (f.tags||[]).join(', ');
        fldIcon.value = f.icon || '';
        btnDelete.classList.remove('hidden');
      } else {
        editingId = null;
        sheetTitle.textContent = 'Nieuw favoriet';
        fldTitle.value = '';
        fldUrl.value = '';
        fldCategory.value = '';
        fldTags.value = '';
        fldIcon.value = '';
        btnDelete.classList.add('hidden');
      }
      setTimeout(()=>fldTitle.focus(), 50);
    }
    function closeSheet(){ sheet.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

    function onSave(){
      const title = fldTitle.value.trim() || autoTitleFromUrl(fldUrl.value);
      const url = fldUrl.value.trim();
      const category = fldCategory.value.trim() || 'Overig';
      const tags = fldTags.value.split(',').map(s=>s.trim()).filter(Boolean);
      const icon = fldIcon.value.trim() || faviconFor(url);
      if(!url){ alert('Voer een geldige URL in.'); fldUrl.focus(); return; }
      if(editingId){
        const i = favorites.findIndex(x=>x.id===editingId);
        favorites[i] = { ...favorites[i], title, url, category, tags, icon };
      } else {
        favorites.push({ id: crypto.randomUUID(), title, url, category, tags, icon });
      }
      save();
      renderChips();
      renderGrid();
      closeSheet();
      if(fileHandle) saveToJson(); // autosave naar gekoppeld bestand
    }

    function onDelete(){
      if(!editingId) return;
      if(confirm('Verwijderen?')){
        favorites = favorites.filter(x=>x.id!==editingId);
        save(); renderChips(); renderGrid(); closeSheet();
        if(fileHandle) saveToJson();
      }
    }

    function autoTitleFromUrl(u){
      const d = domainFromUrl(u).replace('www.','');
      if(!d) return 'Nieuwe favoriet';
      const base = d.split('.')[0];
      return base.charAt(0).toUpperCase()+base.slice(1);
    }

    // Web search (dropdown + prefixes)
    function parsePrefix(q){
      const m = q.match(/^([gybl]):\s*(.*)$/i); // g: y: b: l:
      if(!m) return null;
      const map = { g:'google', y:'youtube', b:'bing', l:'linkedin' };
      return { engine: map[m[1].toLowerCase()], query: m[2] };
    }
    function engineUrl(engine, query){
      if(engine==='google') return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
      if(engine==='youtube') return `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
      if(engine==='bing') return `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
      if(engine==='linkedin') return `https://www.linkedin.com/search/results/all/?keywords=${encodeURIComponent(query)}`;
      return '';
    }
    function performWebSearch(query, forcedEngine){
      const pref = parsePrefix(query);
      const engine = forcedEngine || (pref ? pref.engine : searchEngine.value);
      const q = pref ? pref.query : query;
      if(!q) return;
      const url = engineUrl(engine, q);
      if(url) window.open(url, '_blank');
    }

    // Import/Export + JSON actions
    btnOpenJson.addEventListener('click', openJsonFile);
    btnSaveJson.addEventListener('click', saveToJson);

    btnExport.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(favorites,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'one-fav-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(Array.isArray(data)){ favorites = data; save(); renderChips(); renderGrid(); alert('Import voltooid.'); }
        else { alert('Ongeldig bestand.'); }
      } catch { alert('Kon JSON niet lezen.'); }
      e.target.value = '';
    });

    // Events
    txtSearch.addEventListener('input', renderGrid); // live filter
    txtSearch.addEventListener('keypress', (e)=>{
      if(e.key==='Enter'){
        const pref = parsePrefix(txtSearch.value.trim());
        if(pref){ performWebSearch(txtSearch.value.trim()); return; }
        const results = favorites.filter(matchesFilter);
        if(results.length === 0){ performWebSearch(txtSearch.value.trim()); }
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='/' && document.activeElement!==txtSearch){ e.preventDefault(); txtSearch.focus(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); txtSearch.focus(); }
      if((e.altKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); openSheet(null); }
    });

    btnAdd.addEventListener('click', ()=>openSheet(null));
    btnReset.addEventListener('click', ()=>{ if(confirm('Alles resetten?')){ localStorage.removeItem('favorites_v1'); location.reload(); } });
    btnCloseSheet.addEventListener('click', ()=>sheet.classList.add('hidden'));
    btnCancel.addEventListener('click', ()=>sheet.classList.add('hidden'));

    btnSave.addEventListener('click', onSave);
    btnDelete.addEventListener('click', onDelete);

    // INIT
    (async function init(){
      if (favorites.length === 0) {
        await tryLoadDefaultJson();
        if (favorites.length === 0) {
          save();
        }
      }
      renderChips();
      renderGrid();
    })();
  </script>
</body>
</html>
